<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        .section1 {
            background-color: #2C2C2C;
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
        * {
            font-family: 'Poppins', sans-serif;
        }

        

        .box {
            display: none;
        }
        .box .body {
            position: absolute;
            top: 30%;
            left: 10%;            
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0px 24px 80px -40px #00000040;
            padding-top: 20px;
            padding-left: 20px;
            padding-right: 20px;
            padding-bottom: 20px;
        }        

        .frame-20{
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-top: 5px;
            padding: 10px 20px;
            position: relative;
            flex: 0 0 auto;
            background-color: #36a8e0;
            border-radius: 5px;
            box-shadow: 0px 0px 5px #0000001a;            
        }

        .hoverClass:hover{
            cursor:pointer;
            /* background-color :#12bdd0; */
            
        }

        .frame-19{
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 10px 20px;
            margin-top: 5px;
            position: relative;
            flex: 0 0 auto;
            background-color: #ffffff;
            border-radius: 5px;
            box-shadow: 0px 0px 5px #0000001a;            
        }

        .frame-18{
            display: inline-flex;
            align-items: flex-start;
            gap: 298px;
            position: relative;
            flex: 0 0 auto;            
        }

        .text-wrapper-10 {
            position: relative;
            width: fit-content;
            margin-top: -1px;
            font-family: "Poppins-Medium", Helvetica;
            font-weight: 500;
            color: #ffffff;
            font-size: 14px;
            text-align: center;
            letter-spacing: 0;
            line-height: normal;
        }

    </style>

</head>

<body>

    <div class="container-fluid">

        <div class="row">            
            <div class="col-lg-3 col-md-4 col-sm-4 section1 min-vh-100">
                <div class="intructions pt-5">
                    <div class="pt-5 ps-5">
                        <h4 class="pt-5 pb-3 text-white fw-bold">How to use</h4>
                        <ol class="list-unstyled">
                            <li class="text-white pb-4"><span style="display: inline-block; width: 25px; height: 25px; background-color: #FFF; text-align: center; color: black; border-radius: 50%;" class="me-2">1</span>Ensure the file format matches <bold onclick="openInstructions()" style="text-decoration: underline;font-weight: 600;">THIS</bold> sample.</li>
                            <li class="text-white pb-4"><span style="display: inline-block; width: 25px; height: 25px; background-color: #FFF; text-align: center; color: black; border-radius: 50%;" class="me-2">2</span>Upload your CSV or XLSX file.</li>
                            <li class="text-white pb-4"><span style="display: inline-block; width: 25px; height: 25px; background-color: #FFF; text-align: center; color: black; border-radius: 50%;" class="me-2">3</span>Select the language, specify the niche, then click 'Upload and
                                Process'.
                            </li>
                            <li class="text-white pb-4"><span style="display: inline-block; width: 25px; height: 25px; background-color: #FFF; text-align: center; color: black; border-radius: 50%;" class="me-2">4</span>Click <bold onclick="openFileInstructions()" style="text-decoration: underline;font-weight: 600;">HERE</bold> to see file size and number requirements.</li>

                        </ol>
                    </div>
                </div>
            </div>
            <div class="col-lg-9 col-md-8 col-sm-8 section2 min-vh-100">

                <div id="liveAlertPlaceholder">
                </div>


                <div class="row header border-bottom pt-4 px-3">
                    <div class="col-lg-6 text-start">
                        <h2 class="text-dark fw-bold">CSV Filter App</h2>
                    </div>
                    <div class="col-lg-6 text-end">
                        <img src="./logo.svg" alt="" class="img-fluid">
                    </div>
                </div>
                <div class="container">
                    <div class="row">
                        <div class="col-lg-8 mx-auto">
                            <div class="body1 pt-5">
                                <h5 class="fw-bold">Sosoon Filter</h5>
                                <div class="card py-3" style="border-radius: 5px;
                                background: #FFF;
                                box-shadow: 0px 4px 20px 0px rgba(0, 0, 0, 0.10);">
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="exampleFormControlInput1" class="form-label"><h5>Email to send your zip file:</h5></label>
                                            <input type="email" id="email" class="form-control" placeholder="name@example.com">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="body2 pt-5">
                                <h5 class="fw-bold">Upload and Process files :</h5>
                                <div class="card w-2" style="border-radius: 5px;
                                background: #FFF;
                                box-shadow: 0px 4px 20px 0px rgba(0, 0, 0, 0.10);">
                                    <div id="uploaded-files-div" class="card-body" style="display: contents;">

                                        <table class="table">
                                            <thead>
                                              <tr>
                                                <th scope="col">File</th>
                                                <th scope="col">Name</th>
                                                <th scope="col">Language</th>
                                                <th scope="col">Niche</th>
                                              </tr>
                                            </thead>
                                            <tbody>
                                            </tbody>
                                        </table>     
                
                                    </div>
                                </div>
                            </div>



                            <div class="frame-18">
                
                                <div onclick="checkInputsValue()"  id="acceptButton" class="frame-19 hoverClass" style="display:none;">
                                    <img class="iconsax-linear" src="agreeButton.svg" />
                                    <div class="text-wrapper-9">Agree & Process</div>
                                </div>
                
                                <div class="frame-20">
                                    <input type="file" accept=".csv, .xlsx" id="file-input" class="upload-file" style="display: none;" multiple />
                                    <img class="upload-file" src="./upload-icon.svg" />
                                    <label for="file-input" class="upload-button hoverClass">
                                        <div class="text-wrapper-10">Upload All Files</div>
                                    </label>
                                </div>
                            </div>
                
                            

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



        <!-- Pop-Ups -->
        <div id="instructionsBox" class="box">
            <div class="body">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>TwitterID</th>
                            <th>ProfileLink</th>
                            <th>Followers</th>
                            <th>Following</th>
                            <th>Bio</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th scope="row">1</th>
                            <td>@elonmusk</td>
                            <td>https://twitter.com/elonmusk</td>
                            <td>154,400,000</td>
                            <td>416</td>
                            <td>Empty</td>
                        </tr>
                        <tr>
                            <th scope="row">2</th>
                            <td>@SosoonOfficial</td>
                            <td>https://twitter.com/SosoonOfficial</td>
                            <td>891</td>
                            <td>3,846</td>
                            <td>üéØ Sosoon : Changez la donne sur Twitter & Pinterest üê¶üìå D√©passez vos limites üí•
                                #AmplificateurDeVisibilit√© #SosoonSuccess</td>
                        </tr>
                        <tr>
                            <th scope="row">3</th>
                            <td>@sorcierdelecom</td>
                            <td>https://twitter.com/sorcierdelecom</td>
                            <td>14,700</td>
                            <td>185</td>
                            <td>Je t'apprends √† cr√©er un compte Twitter dans un pays inexploit√© et le mon√©tiser jusqu'√† 5000‚Ç¨
                                par mois üß† | La m√©thode BATX Premium üëâ http://bit.ly/batx5000</td>
                        </tr>    
                    </tbody>
                  </table>
                  
                  <button type="button" onclick="openInstructions()" class="btn btn-success btn-lg">Close</button>
            </div>
        </div>

        <div id="filesInstructionsBox" class="box">
            <div class="body">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>File Size</th>
                            <th>File Format</th>
                            <th>Files Quantity</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <th scope="row">1</th>
                            <td>Upto 3MB maximum allowed</td>
                            <td>Excel / CSV (.xlsx,csv)</td>
                            <td>Upload upto 15 files each <= 3MB</td>
                        </tr>
                    </tbody>
                  </table>                
                  <button type="button" onclick="openFileInstructions()" class="btn btn-success btn-lg">Close</button>
            </div>
        </div>        
    
        <!-- Modal -->
        <div class="modal fade" id="myModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Modal title</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">

                    <div class="container-fluid">            
                        <% conditonsBody.forEach(function(condition) { %>
                            <div class="row">
                                <div class="col-md-5">
                                    <h6><%=condition.title%></h6>
                                    <%=condition.description%>
                                </div>
                            </div>
                        <% })%>
                    </div>


                </div>
                <div class="modal-footer">
                <button type="button" id="close" class="btn btn-danger" data-dismiss="modal">Close</button>
                <button type="button" id="submit" onclick="handleSubmit()" class="btn btn-primary">Upload & Process</button>
                </div>
            </div>
            </div>
        </div>

    <script>
        let idList = [];


        const alertPlaceholder = document.getElementById('liveAlertPlaceholder')
        const appendAlert = (message, type) => {
        const wrapper = document.createElement('div')
        message = message.toString();
            type = type.toString();
        console.log("___>" , message , type)
        wrapper.innerHTML = [
            `<div class="alert alert-${type} alert-dismissible" role="alert">`,
            `   <div>${message}</div>`,
            '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
            '</div>'
        ].join('')

        alertPlaceholder.append(wrapper)
        }

        function showAlert( message , type ){
            appendAlert(message , type) 
        }


        function checkInputsValue(){
            $('#myModal').modal('show'); 
        }

        function openFileInstructions(){
            let instructionsBox = document.getElementById("filesInstructionsBox");
            if (instructionsBox.style.display === "none" || instructionsBox.style.display === "") {
                instructionsBox.style.display = "block";
            } else {
                instructionsBox.style.display = "none";
            }
        }

        function openInstructions(){
            let instructionsBox = document.getElementById("instructionsBox");
            if (instructionsBox.style.display === "none" || instructionsBox.style.display === "") {
                instructionsBox.style.display = "block";
            } else {
                instructionsBox.style.display = "none";
            }
        }



        function handleSubmit(){

            const button = document.getElementById("submit");
            const closeButton  =document.getElementById("close");

            button.disabled = true;
            closeButton.disabled = true;
            button.textContent  = "Uploading ..."

            const emailElement = document.getElementById("email");


            // const fileInput = document.querySelectorAll('.myFile');
            const fileInput =  $("#file-input");

            let languagesValueList = [];
            let nicheValuesList = [];

            const formData = new FormData();
            formData.append("email" , emailElement.value);

            for (let i = 0; i < idList.length; i++) {
                let languageId = `language_code${i}`;
                let nicheId = `niche${i}`;
                let languageElement = document.getElementById(languageId);
                let nicheElement = document.getElementById(nicheId);
                languagesValueList.push( languageElement.value );
                nicheValuesList.push( nicheElement.value );
            }                

            formData.append("languagesList" , JSON.stringify(languagesValueList))
            formData.append("nicheList" , JSON.stringify(nicheValuesList))


            var files = fileInput[0].files

            // Append all selected files to the FormData object
            for (let i = 0; i < files.length; i++) {
                var file = files[i];
                formData.append('files', file);
            }

            var requestOptions = {
                method: 'POST',
                body: formData,
                redirect: 'follow'
            };



            var URL = "<%= API_URL %>";


            fetch( URL , requestOptions)
                        .then(response => response.json())
                        .then(result => { 
                            button.disabled = false;
                            closeButton.disabled = false;
                            button.textContent  = "Upload and Process"
                            console.log("---->" , {result})
                            if(result.status){
                                $('#myModal').modal('hide'); 
                                $("#uploaded-files-div tbody").empty();
                                $("#acceptButton").hide();

                                showAlert("Files Uploaded Successfully" , 'success')
                            }
                            else{
                                $('#myModal').modal('hide');
                                console.log("---->" , result.message)
                                showAlert(result.message , "danger")
                                // alert( result.message )
                            }

                        })
                        .catch(error => {
                            console.log('error', error)
                            button.disabled = false;
                            closeButton.disabled = false;
                            button.textContent  = "Upload and Process"
                            $('#myModal').modal('hide');
                            showAlert(error , "danger")
                            
                        });                

        }        


        $(document).ready(function() {
            $("#file-input").change(function() {
                // Get the selected files
                var files = $(this)[0].files;

                idList = [];

                const languageOptions = <%- JSON.stringify(languageOptions) %>
                console.log({languageOptions})



                $("#uploaded-files-div tbody").empty();
                
                
                var allowedFiles = ["xlsx" , "csv"];
                let uploadCheck = true;
                let fileLengthCheck = true;
                let fileSizeCheck = true;

                if(files.length <= 15 ){
                    // Display file information with icons
                    for (var i = 0; i < files.length; i++) {
                        console.log({i})
                        var file = files[i];
                        var fileSize = (file.size / 1024).toFixed(2) + " KB";
                        
                        var fileList = file.name.split(".");
                        var fileExtension = fileList[ fileList.length - 1 ];

                        if( !allowedFiles.includes( fileExtension ) ){
                            uploadCheck = false;
                            break;
                        }

                        if(fileSize == "3000KB"){
                            fileSizeCheck = false;
                        }


                        var fileIconClass = getFileIconClass(file.name); // Get file icon class based on file extension

                        // Create a table row for each file
                        var tableRow = $("<tr></tr>");
                        
                        // Add file icon cell
                        var iconCell = $("<td></td>").html("<i class='" + fileIconClass + "' style='font-size:70px;color:green'></i>");
                        tableRow.append(iconCell);
                        
                        // Add file name cell
                        var nameCell = $("<td></td>").text(file.name);
                        tableRow.append(nameCell);


                        // Add language cell
                        var languageCell = $("<td></td>");
                        var selectCell = $(`<select id="language_code${i}" name="language_code${i}" class="div-wrapper">`);
                        $.each(languageOptions, function(index, option) {
                            selectCell.append(
                                $("<option>", {
                                    value: option.value,
                                    text: option.text
                                })
                            );
                        }); 
                        languageCell.append( selectCell );
                        tableRow.append(languageCell);


                        
                        // Add Niche cell
                        var nicheCell = $("<td></td>");
                        var nicheInputField = $(`<input id="niche${i}" name="niche${i}" class='div-wrapper' type='text' >`);
                        nicheCell.append( nicheInputField );
                        tableRow.append(nicheCell);


                        // Append the row to the table
                        $("#uploaded-files-div tbody").append(tableRow);
                        idList.push(i)
                    }


                }
                else{
                    fileLengthCheck = false;
                }


                if(!fileSizeCheck){
                    showAlert("Files upto size 3MB are allowed" , "danger")
                }

                else if(!fileLengthCheck){
                    // alert("Kindly Upload upto 10 files only")
                    showAlert("Kindly Upload upto 15 files only" , "danger")

                }

                else if(uploadCheck){
                    $("#acceptButton").show();
                }
                else{
                    alert("kindly select only Excel or CSV file")
                }


            });

            // Function to get file icon class based on file extension
            function getFileIconClass(fileName) {
                var extension = fileName.split('.').pop().toLowerCase();
                console.log({extension})
                switch (extension) {
                    case 'xls':
                    case 'xlsx':
                        return 'far fa-file-excel';
                    default:
                        return 'far fa-file-excel';
                }
            }
        });

    </script>


</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

</html>